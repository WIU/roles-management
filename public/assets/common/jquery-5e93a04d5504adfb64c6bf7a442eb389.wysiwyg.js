/**
 * WYSIWYG - jQuery plugin 0.6
 *
 * Copyright (c) 2008-2009 Juan M Martinez
 * http://plugins.jquery.com/project/jWYSIWYG
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * $Id: $
 */
(function(a){function b(a,c){return this instanceof b?this.init(a,c):new b(a,c)}a.fn.document=function(){var a=this.get(0);return a.nodeName.toLowerCase()=="iframe"?a.contentWindow.document:this},a.fn.documentSelection=function(){var a=this.get(0);return a.contentWindow.document.selection?a.contentWindow.document.selection.createRange().text:a.contentWindow.getSelection().toString()},a.fn.wysiwyg=function(c){if(arguments.length>0&&arguments[0].constructor==String){var d=arguments[0].toString(),e=[];for(var f=1;f<arguments.length;f++)e[f-1]=arguments[f];return d in b?this.each(function(){a.data(this,"wysiwyg").designMode(),b[d].apply(this,e)}):this}var g={};if(c&&c.controls){var g=c.controls;delete c.controls}c=a.extend({html:'<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">STYLE_SHEET</head><body style="margin: 0px;">INITIAL_CONTENT</body></html>',css:{},debug:!1,autoSave:!0,rmUnwantedBr:!0,brIE:!0,controls:{},messages:{}},c),c.messages=a.extend(!0,c.messages,b.MSGS_EN),c.controls=a.extend(!0,c.controls,b.TOOLBAR);for(var h in g)h in c.controls?a.extend(c.controls[h],g[h]):c.controls[h]=g[h];return this.each(function(){b(this,c)})},a.extend(b,{insertImage:function(c,d){var e=a.data(this,"wysiwyg");if(e.constructor==b&&c&&c.length>0){a.browser.msie&&e.focus();if(d){e.editorDoc.execCommand("insertImage",!1,"#jwysiwyg#");var f=e.getElementByAttributeValue("img","src","#jwysiwyg#");if(f){f.src=c;for(var g in d)f.setAttribute(g,d[g])}}else e.editorDoc.execCommand("insertImage",!1,c)}},createLink:function(c){var d=a.data(this,"wysiwyg");if(d.constructor==b&&c&&c.length>0){var e=a(d.editor).documentSelection();e.length>0?(a.browser.msie&&d.focus(),d.editorDoc.execCommand("unlink",!1,[]),d.editorDoc.execCommand("createLink",!1,c)):d.options.messages.nonSelection&&alert(d.options.messages.nonSelection)}},insertHtml:function(c){var d=a.data(this,"wysiwyg");if(d.constructor==b&&c&&c.length>0)if(a.browser.msie){d.focus(),d.editorDoc.execCommand("insertImage",!1,"#jwysiwyg#");var e=d.getElementByAttributeValue("img","src","#jwysiwyg#");e&&a(e).replaceWith(c)}else d.editorDoc.execCommand("insertHTML",!1,c)},setContent:function(b){var c=a.data(this,"wysiwyg");c.setContent(b),c.saveContent()},clear:function(){var b=a.data(this,"wysiwyg");b.setContent(""),b.saveContent()},MSGS_EN:{nonSelection:"select the text you wish to link"},TOOLBAR:{bold:{visible:!0,tags:["b","strong"],css:{fontWeight:"bold"},tooltip:"Bold"},italic:{visible:!0,tags:["i","em"],css:{fontStyle:"italic"},tooltip:"Italic"},strikeThrough:{visible:!0,tags:["s","strike"],css:{textDecoration:"line-through"},tooltip:"Strike-through"},underline:{visible:!0,tags:["u"],css:{textDecoration:"underline"},tooltip:"Underline"},separator00:{visible:!0,separator:!0},justifyLeft:{visible:!0,css:{textAlign:"left"},tooltip:"Justify Left"},justifyCenter:{visible:!0,tags:["center"],css:{textAlign:"center"},tooltip:"Justify Center"},justifyRight:{visible:!0,css:{textAlign:"right"},tooltip:"Justify Right"},justifyFull:{visible:!0,css:{textAlign:"justify"},tooltip:"Justify Full"},separator01:{visible:!0,separator:!0},indent:{visible:!0,tooltip:"Indent"},outdent:{visible:!0,tooltip:"Outdent"},separator02:{visible:!1,separator:!0},subscript:{visible:!0,tags:["sub"],tooltip:"Subscript"},superscript:{visible:!0,tags:["sup"],tooltip:"Superscript"},separator03:{visible:!0,separator:!0},undo:{visible:!0,tooltip:"Undo"},redo:{visible:!0,tooltip:"Redo"},separator04:{visible:!0,separator:!0},insertOrderedList:{visible:!0,tags:["ol"],tooltip:"Insert Ordered List"},insertUnorderedList:{visible:!0,tags:["ul"],tooltip:"Insert Unordered List"},insertHorizontalRule:{visible:!0,tags:["hr"],tooltip:"Insert Horizontal Rule"},separator05:{separator:!0},createLink:{visible:!0,exec:function(){var b=a(this.editor).documentSelection();if(b.length>0)if(a.browser.msie)this.focus(),this.editorDoc.execCommand("createLink",!0,null);else{var c=prompt("URL","http://");c&&c.length>0&&(this.editorDoc.execCommand("unlink",!1,[]),this.editorDoc.execCommand("createLink",!1,c))}else this.options.messages.nonSelection&&alert(this.options.messages.nonSelection)},tags:["a"],tooltip:"Create link"},insertImage:{visible:!0,exec:function(){if(a.browser.msie)this.focus(),this.editorDoc.execCommand("insertImage",!0,null);else{var b=prompt("URL","http://");b&&b.length>0&&this.editorDoc.execCommand("insertImage",!1,b)}},tags:["img"],tooltip:"Insert image"},separator06:{separator:!0},h1mozilla:{visible:a.browser.mozilla,className:"h1",command:"heading",arguments:["h1"],tags:["h1"],tooltip:"Header 1"},h2mozilla:{visible:a.browser.mozilla,className:"h2",command:"heading",arguments:["h2"],tags:["h2"],tooltip:"Header 2"},h3mozilla:{visible:a.browser.mozilla,className:"h3",command:"heading",arguments:["h3"],tags:["h3"],tooltip:"Header 3"},h1:{visible:!a.browser.mozilla,className:"h1",command:"formatBlock",arguments:["<H1>"],tags:["h1"],tooltip:"Header 1"},h2:{visible:!a.browser.mozilla,className:"h2",command:"formatBlock",arguments:["<H2>"],tags:["h2"],tooltip:"Header 2"},h3:{visible:!a.browser.mozilla,className:"h3",command:"formatBlock",arguments:["<H3>"],tags:["h3"],tooltip:"Header 3"},separator07:{visible:!1,separator:!0},cut:{visible:!1,tooltip:"Cut"},copy:{visible:!1,tooltip:"Copy"},paste:{visible:!1,tooltip:"Paste"},separator08:{separator:!1},increaseFontSize:{visible:!1,tags:["big"],tooltip:"Increase font size"},decreaseFontSize:{visible:!1,tags:["small"],tooltip:"Decrease font size"},separator09:{separator:!0},html:{visible:!1,exec:function(){this.viewHTML?(this.setContent(a(this.original).val()),a(this.original).hide()):(this.saveContent(),a(this.original).show()),this.viewHTML=!this.viewHTML},tooltip:"View source code"},removeFormat:{visible:!0,exec:function(){a.browser.msie&&this.focus(),this.editorDoc.execCommand("removeFormat",!1,[]),this.editorDoc.execCommand("unlink",!1,[])},tooltip:"Remove formatting"}}}),a.extend(b.prototype,{original:null,options:{},element:null,editor:null,focus:function(){a(this.editorDoc.body).focus()},init:function(b,c){var d=this;this.editor=b,this.options=c||{},a.data(b,"wysiwyg",this);var e=b.width||b.clientWidth,f=b.height||b.clientHeight;if(b.nodeName.toLowerCase()=="textarea"){this.original=b,e==0&&b.cols&&(e=b.cols*8+21),f==0&&b.rows&&(f=b.rows*16+16);var g=this.editor=a('<iframe src="javascript:false;"></iframe>').css({minHeight:(f-6).toString()+"px",width:(e-0).toString()+"px"}).attr("id",a(b).attr("id")+"IFrame").attr("frameborder","0");this.editor.attr("tabindex",a(b).attr("tabindex")),a.browser.msie&&this.editor.css("height",f.toString()+"px")}var h=this.panel=a('<ul role="menu" class="panel"></ul>');this.appendControls(),this.element=a("<div></div>").css({width:e>0?e.toString()+"px":"100%"}).addClass("wysiwyg").append(h).append(a("<div><!-- --></div>").css({clear:"both"})).append(g),a(b).hide().before(this.element),this.viewHTML=!1,this.initialHeight=f-8,this.initialContent=a(b).val(),this.initFrame(),this.initialContent.length==0&&this.setContent("");var i=a(b).closest("form");this.options.autoSave&&i.submit(function(){d.saveContent()}),i.bind("reset",function(){d.setContent(d.initialContent),d.saveContent()})},initFrame:function(){var b=this,c="";this.options.css&&this.options.css.constructor==String&&(c='<link rel="stylesheet" type="text/css" media="screen" href="'+this.options.css+'" />'),this.editorDoc=a(this.editor).document(),this.editorDoc_designMode=!1;try{this.editorDoc.designMode="on",this.editorDoc_designMode=!0}catch(d){a(this.editorDoc).focus(function(){b.designMode()})}this.editorDoc.open(),this.editorDoc.write(this.options.html.replace(/INITIAL_CONTENT/,function(){return b.initialContent}).replace(/STYLE_SHEET/,function(){return c})),this.editorDoc.close(),this.editorDoc.contentEditable="true",a.browser.msie&&setTimeout(function(){a(b.editorDoc.body).css("border","none")},0),a(this.editorDoc).click(function(a){b.checkTargets(a.target?a.target:a.srcElement)}),a(this.original).focus(function(){a.browser.msie||b.focus()}),this.options.autoSave&&a(this.editorDoc).keydown(function(){b.saveContent()}).keyup(function(){b.saveContent()}).mousedown(function(){b.saveContent()}),this.options.css&&setTimeout(function(){b.options.css.constructor!=String&&a(b.editorDoc).find("body").css(b.options.css)},0),a(this.editorDoc).keydown(function(c){if(a.browser.msie&&b.options.brIE&&c.keyCode==13){var d=b.getRange();return d.pasteHTML("<br />"),d.collapse(!1),d.select(),!1}return!0})},designMode:function(){if(!this.editorDoc_designMode)try{this.editorDoc.designMode="on",this.editorDoc_designMode=!0}catch(a){}},getSelection:function(){return window.getSelection?window.getSelection():document.selection},getRange:function(){var a=this.getSelection();return a?a.rangeCount>0?a.getRangeAt(0):a.createRange():null},getContent:function(){return a(a(this.editor).document()).find("body").html()},setContent:function(b){a(a(this.editor).document()).find("body").html(b)},saveContent:function(){if(this.original){var b=this.getContent();this.options.rmUnwantedBr&&(b=b.substr(-4)=="<br>"?b.substr(0,b.length-4):b),a(this.original).val(b)}},withoutCss:function(){if(a.browser.mozilla)try{this.editorDoc.execCommand("styleWithCSS",!1,!1)}catch(b){try{this.editorDoc.execCommand("useCSS",!1,!0)}catch(b){}}},appendMenu:function(b,c,d,e,f){var g=this;c=c||[],a("<li></li>").append(a('<a role="menuitem" tabindex="-1" href="javascript:;">'+(d||b)+"</a>").addClass(d||b).attr("title",f)).click(function(){e?e.apply(g):(g.withoutCss(),g.editorDoc.execCommand(b,!1,c)),g.options.autoSave&&g.saveContent()}).appendTo(this.panel)},appendMenuSeparator:function(){a('<li role="separator" class="separator"></li>').appendTo(this.panel)},appendControls:function(){for(var a in this.options.controls){var b=this.options.controls[a];b.separator?b.visible!==!1&&this.appendMenuSeparator():b.visible&&this.appendMenu(b.command||a,b.arguments||[],b.className||b.command||a||"empty",b.exec,b.tooltip||b.command||a||"")}},checkTargets:function(b){for(var c in this.options.controls){var d=this.options.controls[c],e=d.className||d.command||c||"empty";a("."+e,this.panel).removeClass("active");if(d.tags){var f=b;do{if(f.nodeType!=1)break;a.inArray(f.tagName.toLowerCase(),d.tags)!=-1&&a("."+e,this.panel).addClass("active")}while(f=f.parentNode)}if(d.css){var f=a(b);do{if(f[0].nodeType!=1)break;for(var g in d.css)f.css(g).toString().toLowerCase()==d.css[g]&&a("."+e,this.panel).addClass("active")}while(f=f.parent())}}},getElementByAttributeValue:function(b,c,d){var e=this.editorDoc.getElementsByTagName(b);for(var f=0;f<e.length;f++){var g=e[f].getAttribute(c);a.browser.msie&&(g=g.substr(g.length-d.length));if(g==d)return e[f]}return!1}})})(jQuery)